# ================================================================
# 磁場・温度一括ベイズ推定プログラム用 設定ファイル (config_unified.yml)
# unified_weighted_bayesian_fitting.py 専用
# ================================================================

# --- ファイルパス設定 ---
file_paths:
  # 複数データファイル対応
  # 各ファイルから温度列('K'で終わる)と磁場列('T'で終わる)を自動検出
  data_files:
    # 温度変化データファイル
    - file: "bayesian_inputs/BayesianInput_Raw_Transmittance_Temperature.xlsx"
      sheet: "Normalized Data"
      type: "temperature"
      description: "温度変化データ (B=9.0T固定)"
    
    # 磁場変化データファイル
    - file: "bayesian_inputs/BayesianInput_Raw_Transmittance_Field.xlsx"
      sheet: "Normalized Data"
      type: "field"
      description: "磁場変化データ (T=4K固定)"
  
  # 結果を出力する親ディレクトリ名
  results_parent_dir: "fullsize_analysis_results_unified"

# --- 実行環境設定（CPU並列化） ---
execution:
  # 1チェーンあたりのCPUスレッド数（行列演算の並列化）
  # 
  # ベクトル化計算により、NumPyブロードキャストがMKL/OpenBLASを活用
  # 
  # c7i.8xlarge (32 vCPU) の推奨設定:
  #   - chains=8, threads_per_chain=4 → 32 vCPU使用
  threads_per_chain: 4

# --- 物理パラメータ・初期値 ---
physical_parameters:
  # 温度変化データの固定磁場 (Tesla)
  B_fixed: 9.0
  # 磁場変化データの固定温度 (Kelvin) - load_unified_data関数内で使用
  T_fixed: 4.0
  # 膜厚 (meter) - 固定値として使用
  d_fixed: 157.8e-6
  # スピン量子数
  s: 3.5
  # スピン密度 (m^-3)
  N_spin: 1.9386e+28 # 24 / 1.238 * 1e27

  # --- パラメータの初期値 ---
  # 【THz単位系】数値計算安定性のため、周波数・緩和率はTHz単位で統一
  # 【修正】指導教員の指導に基づき、文献値を初期値に設定
  initial_values:
    eps_bg: 14.20
    g_factor: 2.00          # 【修正】1.990 → 2.00 (Gd3+標準値)
    B4: 0.00202             # 【固定】文献値 B4 = 0.00202 K
    B6: -0.000012           # 【固定】文献値 B6 = -0.000012 K  
    gamma: 0.018            # 減衰定数γの初期値 [THz]
    a_scale: 0.70           # スケーリング係数の初期値（無次元）

# --- 解析条件設定 ---
analysis_settings:
  # 温度・磁場データの自動検出設定
  # - 温度列: 列名が'K'で終わる列を自動検出(例: '4K', '10K', '30K', '100K', '300K', ...)
  # - 磁場列: 列名が'T'で終わる列を自動検出(例: '1T', '2T', '3T', ...)
  # ※温度列と磁場列の両方が自動検出され、温度列を除外した上で磁場列が判定される
  # ※Excelファイルにこれらの列がない場合は処理されない
  
  # 周波数領域のカットオフ値 (THz)
  low_freq_cutoff: 0.361505   # 低周波カットオフ（現在未使用）
  high_freq_cutoff: 0.45       # 高周波カットオフ（eps_bgフィッティング用）
  
  # --- 重み付け設定 ---
  weight_settings:
    # ピーク検出の閾値設定
    peak_height_threshold: 0.01      # ピーク検出の最小高さ（正規化透過率）
    peak_prominence_threshold: 0.04  # ピーク検出のプロミネンス閾値
    peak_distance: 10                # ピーク間の最小距離（データ点数）
    
    # 重み値設定  
    lp_up_peak_weight: 1.0          # LP・UPピーク領域の重み
    between_peaks_weight: 0.4       # LP-UP間の重み
    high_freq_peak_weight: 1.0      # 高周波ピークの重み
    background_weight: 0.01         # その他の領域の重み（バックグラウンド）

# --- ベイズ推定事前分布設定 ---
bayesian_priors:
  # 【修正】多峰性克服のため事前分布を大幅に調整
  # 【戦略】
  # 1. B4, B6を文献値に固定し、それらが自由変数になることを防止
  # 2. g因子の分散をσ=0.05→0.15に拡大し、1.8-2.2の全範囲を探索可能に
  # 3. 他のパラメータの制約を調和
  
  magnetic_parameters:
    # a_scale パラメータ (TruncatedNormal分布)
    # 補正係数は1.0周辺に収まるべき
    a_scale:
      distribution: "TruncatedNormal"
      mu: 1.0
      sigma: 0.15         # 【修正】0.2 → 0.15: g因子の自由度を持たせるため調整
      lower: 0.0
      upper: 2.0
    
    # g因子 (TruncatedNormal分布)
    # 【重要修正】Gd3+のg因子多峰性問題への対策
    # - 多峰性は g ≈ 1.8, 2.1, 2.3 に存在
    # - 解決策: σ を拡大し、全領域の探索を許容
    # - 副作用: B4, B6をより強く固定し、代償が起きないようにする
    g_factor:
      distribution: "TruncatedNormal"
      mu: 2.00            # 【修正】文献値に統一
      sigma: 0.15         # 【大幅修正】0.05 → 0.15（多峰性対策）
      lower: 1.80         # 【修正】1.8 → 1.80
      upper: 2.20         # 【修正】2.2 → 2.20
    
    # 結晶場パラメータ B4 (TruncatedNormal分布)
    # 【重要修正】Normal → TruncatedNormal + 文献値を中心値に固定
    # - 指導教員指摘: "B4文献値: 0.00202 K を初期値（中心値）として設定し、
    #   そこから大きく外れないように制約をかけます"
    B4:
      distribution: "TruncatedNormal"
      mu: 0.00202         # 【修正】文献値を中心に固定
      sigma: 0.0002       # 【修正】Normal → TruncatedNormal + σ狭小化
      lower: 0.001        # B4の物理的下限
      upper: 0.003        # B4の物理的上限
    
    # 結晶場パラメータ B6 (TruncatedNormal分布)
    # 【重要修正】Normal → TruncatedNormal + 文献値を中心値に固定
    # - "B6文献値: -0.000012 K を初期値（中心値）として設定し、そこから大きく外れないように制約をかけます"
    B6:
      distribution: "TruncatedNormal"
      mu: -0.000012       # 【修正】文献値を中心に固定
      sigma: 0.000002     # 【修正】Normal → TruncatedNormal + σ極小化
      lower: -0.00002     # B6の物理的下限
      upper: -0.000005    # B6の物理的上限
  
  # 事前情報がある場合の設定（2回目以降の反復で使用）
  with_prior_info:
    # a_scale (TruncatedNormal分布)
    a_scale:
      distribution: "TruncatedNormal"
      sigma: 0.1          # 【修正】0.15 → 0.1: 前回結果を信頼
      lower: 0.0
      upper: 2.0
    
    # g因子 (TruncatedNormal分布)
    # 【重要】多峰性解消のため、初回と同じ広い分布を保持
    g_factor:
      distribution: "TruncatedNormal"
      mu: 2.00            # 文献値に統一
      sigma: 0.15         # 【保持】初回と同じ広さ（非識別性対策）
      lower: 1.80
      upper: 2.20
    
    # B4 (TruncatedNormal分布)
    # 【修正】Normal → TruncatedNormal + 文献値を堅く固定
    B4:
      distribution: "TruncatedNormal"
      mu: 0.00202         # 文献値
      sigma: 0.0001       # 【修正】0.0002 → 0.0001: 反復で更に厳密化
      lower: 0.001
      upper: 0.003
    
    # B6 (TruncatedNormal分布)
    # 【修正】Normal → TruncatedNormal + 文献値を堅く固定
    B6:
      distribution: "TruncatedNormal"
      mu: -0.000012       # 文献値
      sigma: 0.000001     # 【修正】0.000002 → 0.000001: 反復で更に厳密化
      lower: -0.00002
      upper: -0.000005
  
  # gamma（減衰定数）関連の事前分布設定
  gamma_parameters:
    # log(gamma)のベース値
    log_gamma_mu_base:
      distribution: "Normal"
      sigma: 1.0
    
    # log(gamma)の分散（各遷移間の相関を制御）
    log_gamma_sigma_base:
      distribution: "HalfNormal"
      sigma: 0.5
    
    # 各遷移のoffset（7つの遷移に対応）
    log_gamma_offset_base:
      distribution: "Normal"
      mu: 0.0
      sigma: 0.5
      shape: 7
    
    # 温度依存性係数（線形項）
    # 【重要修正】多峰性克服と温度依存性の両立を実現
    # - 前回の temp_gamma_slope = 0.27 (B_form) は多峰性による過度な補償が原因
    # - B4/B6を文献値で固定することで、slope は自然な温度依存を学習可能に
    # - 改定: mu=0.003, sigma=0.15 (広さと物理的妥当性のバランス)
    # - 物理的根拠:
    #   * ΔT=296K(4K→300K)時: 95%信頼区間で γ(300K)/γ(4K) ∈ [0.1, 10]
    #   * これは固体物理の一般的な温度依存性範囲に合致
    #   * narrow prior (σ=0.03) では線形モデルの柔軟性が不足
    temp_gamma_slope:
      distribution: "Normal"
      mu: 0.003           # 基本的には控えめな温度依存性
      sigma: 0.15         # 【大幅修正】0.03 → 0.15（4K～300K対応可能）
  
  # ノイズパラメータ
  noise_parameters:
    sigma:
      distribution: "HalfNormal"
      sigma: 0.05
  
  # B_form専用の事前分布設定（初回実行時）
  # B_formは μ_r = 1/(1-χ) の形式で数値的不安定性が高い
  # より強い制約で収束を促進
  b_form_magnetic_parameters:
    # 【修正】H_formの設定に統一（重要な非識別性は共通）
    a_scale:
      distribution: "TruncatedNormal"
      mu: 1.0             # H_formと統一
      sigma: 0.15         # H_formと統一
      lower: 0.0
      upper: 2.0
    
    g_factor:
      distribution: "TruncatedNormal"
      mu: 2.00            # H_formと統一
      sigma: 0.15         # 【重要】H_formと統一（多峰性対策）
      lower: 1.80
      upper: 2.20
    
    B4:
      distribution: "TruncatedNormal"
      mu: 0.00202         # H_formと統一
      sigma: 0.0002       # H_formと統一
      lower: 0.001
      upper: 0.003
    
    B6:
      distribution: "TruncatedNormal"
      mu: -0.000012       # H_formと統一
      sigma: 0.000002     # H_formと統一
      lower: -0.00002
      upper: -0.000005
  
  # B_form専用の事前情報がある場合の設定（2回目以降）
  b_form_with_prior_info:
    a_scale:
      distribution: "TruncatedNormal"
      sigma: 0.1
      lower: 0.0
      upper: 2.0
    
    g_factor:
      distribution: "TruncatedNormal"
      mu: 2.00
      sigma: 0.15         # 【重要】H_formと統一
      lower: 1.80
      upper: 2.20
    
    B4:
      distribution: "TruncatedNormal"
      mu: 0.00202
      sigma: 0.0001
      lower: 0.001
      upper: 0.003
    
    B6:
      distribution: "TruncatedNormal"
      mu: -0.000012
      sigma: 0.000001
      lower: -0.00002
      upper: -0.000005
  
  # B_form専用のgammaパラメータ
  b_form_gamma_parameters:
    log_gamma_mu_base:
      distribution: "Normal"
      sigma: 0.8
    
    log_gamma_sigma_base:
      distribution: "HalfNormal"
      sigma: 0.4
    
    log_gamma_offset_base:
      distribution: "Normal"
      mu: 0.0
      sigma: 0.4
      shape: 7
    
    temp_gamma_slope:
      distribution: "Normal"
      mu: 0.003           # H_formと統一
      sigma: 0.15         # 【修正】0.03 → 0.15（広い温度範囲対応）

# --- MCMCサンプリング設定 ---
mcmc:
  # サンプリング数（チェーンごと）
  draws: 4000    # 収束改善のため増加
  # チューニング（warmup）期間
  tune: 2000     # 多峰性対策のため増加
  # 並列チェーン数
  chains: 8
  # 並列実行コア数（chains数と同じに設定）
  cores: 8
  # 受理率の目標値（高いほど慎重にサンプリング）
  target_accept: 0.95  # 発散防止のため高めに設定
  
  # B_form専用の強化設定（収束困難なモデル用）
  b_form_overrides:
    draws: 8000         # H_formの2倍（より多くのサンプル）
    tune: 4000          # 長いチューニング期間
    target_accept: 0.98 # より慎重なサンプリング
    max_iterations: 3   # 追加の反復でeps_bg更新
  # パラメータ更新の反復回数
  # 各反復でeps_bgを更新してベイズ推定を再実行
  max_iterations: 2
  # 初期化戦略
  init: "adapt_diag"
  # 再現性確保のための乱数シード
  random_seed: 42
  # GPU並列計算用のサンプラーを指定（カスタムOpと非互換のためコメントアウト）
  # nuts_sampler: "numpyro"  

# --- データセット設定（統合処理用） ---
dataset_config:
  # 温度変化データの説明
  temp_variable:
    enabled: true
    description: "温度を変数、磁場を固定したデータセット"
    # B_fixedと自動検出された温度列('K'で終わる列)から自動生成
  
  # 磁場変化データの説明
  field_variable:
    enabled: true
    description: "磁場を変数、温度を固定したデータセット"
    # T_fixedと自動検出された磁場列('T'で終わる列)から生成

# --- 出力設定 ---
output:
  # 保存するファイル
  save_trace: true              # traceファイル（.nc）を保存
  save_parameters: true         # パラメータCSVを保存
  save_bt_params: true          # (B,T)別光学パラメータCSVを保存