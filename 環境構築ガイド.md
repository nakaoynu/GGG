# GGG研究プロジェクト - Python環境構築ガイド

**対象:** プログラミング初心者の研究室メンバー  
**作成日:** 2025年11月4日  
**対象プログラム:** `weighted_bayesian_fitting_completed.py`（ベイズ推定による磁性解析）

---

## 📚 目次

1. [はじめに](#はじめに)
2. [必要な知識](#必要な知識)
3. [環境構築の全体像](#環境構築の全体像)
4. [詳細な手順](#詳細な手順)
5. [トラブルシューティング](#トラブルシューティング)
6. [よくある質問](#よくある質問)

---

## はじめに

### このガイドの目的

このドキュメントでは、`weighted_bayesian_fitting_completed.py`を実行するために必要なPython環境を、**ゼロから構築する手順**を説明します。プログラミングの経験がなくても、この手順に従えば確実に環境を構築できます。

### 完成後にできること

- PyMCを使ったベイズ推定による磁性データの解析
- 温度依存性・磁場依存性の物理パラメータフィッティング
- 高速な数値計算（C++コンパイラによる最適化）

---

## 必要な知識

### 前提条件

- ✅ Windowsの基本操作（ファイルのダウンロード、アプリのインストール）
- ✅ PowerShellの起動方法
- ❌ プログラミング経験は不要

### 用語解説

| 用語 | 説明 |
|------|------|
| **conda** | Python環境を管理するツール。複数のプロジェクトで異なるバージョンのPythonやパッケージを使い分けられる |
| **Miniconda** | condaを含む最小限のPythonパッケージ。Anacondaの軽量版 |
| **環境 (environment)** | Pythonとパッケージの組み合わせ。プロジェクトごとに分けることで、互いに干渉しない |
| **パッケージ** | 便利な機能をまとめたプログラムの部品（例：NumPy、PyMC） |
| **PowerShell** | Windowsのコマンドライン操作ツール |

---

## 環境構築の全体像

### 構築ステップ（所要時間: 約30分〜1時間）

```
1. Windows Store版Pythonの無効化 (5分)
   ↓
2. Minicondaのインストール (10分)
   ↓
3. PowerShellの設定 (5分)
   ↓
4. conda環境の作成 (5分)
   ↓
5. 必要なパッケージのインストール (10分)
   ↓
6. C++コンパイラのインストール (10分)
   ↓
7. 動作確認 (5分)
```

---

## 詳細な手順

## ステップ1: Windows Store版Pythonの無効化

### なぜ必要か？
Windows 10/11には、Microsoft Storeへ誘導するだけの「偽物のPython」が含まれています。これを無効化しないと、正しいPythonがインストールできません。

### 手順

1. **Windowsの設定を開く**
   - `Win + I`キーを押す
   - または、スタートメニュー → 「設定」をクリック

2. **「アプリ」をクリック**

3. **「アプリと機能」→「アプリ実行エイリアス」を選択**
   - 検索ボックスに「アプリ実行エイリアス」と入力すると見つかりやすい

4. **以下の2つをオフにする**
   - ☑️ **アプリインストーラー python.exe** → **オフ**
   - ☑️ **アプリインストーラー python3.exe** → **オフ**

5. **設定を閉じる**

### 確認方法

PowerShellを開いて以下を実行：
```powershell
where.exe python
```

**期待される結果:** 何も表示されない、または「見つかりませんでした」と表示される

---

## ステップ2: Minicondaのインストール

### なぜMiniconda？

| 比較項目 | Miniconda | Anaconda | Python単体 |
|---------|-----------|----------|-----------|
| 容量 | 小（約400MB） | 大（約3〜5GB） | 極小（約100MB） |
| 科学計算の最適化 | ✅ | ✅ | ❌ |
| 環境管理 | ✅ | ✅ | △ |
| **推奨度** | ⭐⭐⭐ | ⭐⭐ | ⭐ |

→ **Minicondaが最もバランスが良い**

### 手順

1. **Miniconda公式サイトにアクセス**
   - URL: https://docs.conda.io/en/latest/miniconda.html

2. **Windows版をダウンロード**
   - 「**Miniconda3 Windows 64-bit**」をクリック
   - ファイル名: `Miniconda3-latest-Windows-x86_64.exe`（約80〜100MB）

3. **インストーラーを実行**
   - ダウンロードしたファイルをダブルクリック

4. **インストール設定（重要！）**

   | 項目 | 選択 | 説明 |
   |------|------|------|
   | Install for | **Just Me (recommended)** | 自分だけが使う |
   | Installation location | デフォルトのまま | `C:\Users\<ユーザー名>\miniconda3` |
   | **Add Miniconda3 to my PATH** | ✅ **チェックを入れる** | PowerShellから使えるようにする |
   | Register as default Python | ✅ チェックを入れる | `python`コマンドでMinicondaを使う |

   ⚠️ **注意:** 「Add to PATH」は警告が出ますが、チェックを入れてください

5. **インストール開始**
   - 「Install」ボタンをクリック
   - 5〜10分待つ

6. **完了**
   - 「Finish」をクリック

---

## ステップ3: PowerShellの設定

### conda初期化

1. **PowerShellを起動**
   - スタートメニューで「PowerShell」と検索
   - **Windows PowerShell**をクリック（管理者権限は不要）

2. **スクリプト実行を許可**
   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
   ```
   - これを実行しないと、condaが動作しません

3. **conda初期化**
   ```powershell
   conda init powershell
   ```
   
   **表示される内容（例）:**
   ```
   modified      C:\Users\taich\OneDrive\画像\ドキュメント\WindowsPowerShell\profile.ps1
   ==> For changes to take effect, close and re-open your current shell. <==
   ```

4. **PowerShellを完全に閉じて、新しいウィンドウを開く**

5. **確認**
   - プロンプトが `(base) PS C:\...` のように `(base)` 付きになっていればOK

---

## ステップ4: conda環境の作成

### なぜ専用環境を作るのか？

- ✅ プロジェクトごとに異なるバージョンのPythonやパッケージを使える
- ✅ 他の研究に影響を与えない
- ✅ 環境が壊れても、削除して作り直せば良い

### 手順

```powershell
# Python 3.10の環境を作成（名前: ggg_bayesian）
conda create -n ggg_bayesian python=3.10 --override-channels -c conda-forge -y
```

**コマンドの意味:**
- `conda create`: 新しい環境を作成
- `-n ggg_bayesian`: 環境名を「ggg_bayesian」にする
- `python=3.10`: Python 3.10をインストール
- `--override-channels -c conda-forge`: conda-forgeチャンネルのみ使用
- `-y`: 確認なしで実行

**実行時間:** 3〜5分

### 確認

```powershell
conda env list
```

**表示例:**
```
# conda environments:
#
base                     C:\Users\taich\miniconda3
ggg_bayesian             C:\Users\taich\miniconda3\envs\ggg_bayesian
```

---

## ステップ5: 必要なパッケージのインストール

### 環境を有効化

```powershell
conda activate ggg_bayesian
```

プロンプトが `(ggg_bayesian) PS C:\...` に変わればOK

### 基本パッケージのインストール

```powershell
conda install --override-channels -c conda-forge numpy pandas matplotlib scipy pyyaml openpyxl -y
```

**インストールされるパッケージ:**
- **NumPy**: 数値計算
- **Pandas**: データ処理
- **Matplotlib**: グラフ描画
- **SciPy**: 科学計算
- **PyYAML**: 設定ファイル読み込み
- **OpenPyXL**: Excelファイル操作

**実行時間:** 5〜10分

### PyMC関連パッケージのインストール

```powershell
pip install pymc arviz pytensor japanize-matplotlib
```

**インストールされるパッケージ:**
- **PyMC**: ベイズ推定のメインライブラリ
- **ArviZ**: ベイズ推定結果の可視化
- **PyTensor**: PyMCのバックエンド（自動微分、最適化）
- **japanize-matplotlib**: グラフの日本語表示（オプション）

**実行時間:** 3〜5分

---

## ステップ6: C++コンパイラのインストール

### なぜ必要か？

PyTensorはC++コンパイラがあると、計算が**数倍〜数十倍高速化**されます。
ない場合でも動作しますが、MCMC計算（ベイズ推定の中核）に数時間かかることがあります。

### 手順

```powershell
conda install --override-channels -c conda-forge gxx -y
```

**実行時間:** 3〜5分

### 環境を再起動

```powershell
conda deactivate
conda activate ggg_bayesian
```

---

## ステップ7: 動作確認

### すべてのパッケージがインポートできるか確認

```powershell
python -c "import numpy, pandas, matplotlib, scipy, pymc, arviz, pytensor; print('✅ All packages imported successfully')"
```

**期待される出力:**
```
✅ All packages imported successfully
```

⚠️ **警告が出る場合:**
```
WARNING (pytensor.configdefaults): g++ not available, if using conda: `conda install gxx`
```
→ ステップ6が正しく完了していれば、次回から出なくなります

### バージョン確認

```powershell
python -c "import sys; import numpy as np; import pandas as pd; import matplotlib; import scipy; import pymc as pm; import arviz as az; import pytensor; print(f'Python: {sys.version}'); print(f'NumPy: {np.__version__}'); print(f'Pandas: {pd.__version__}'); print(f'Matplotlib: {matplotlib.__version__}'); print(f'SciPy: {scipy.__version__}'); print(f'PyMC: {pm.__version__}'); print(f'ArviZ: {az.__version__}'); print(f'PyTensor: {pytensor.__version__}')"
```

**期待される出力例:**
```
Python: 3.10.19 | packaged by conda-forge | (main, Oct 22 2025, 22:23:22) [MSC v.1944 64 bit (AMD64)]
NumPy: 2.2.6
Pandas: 2.3.3
Matplotlib: 3.10.7
SciPy: 1.15.2
PyMC: 5.25.1
ArviZ: 0.22.0
PyTensor: 2.31.7
```

---

## プログラムの実行方法

### 毎回の起動手順

```powershell
# 1. PowerShellを起動

# 2. conda環境を有効化
conda activate ggg_bayesian

# 3. プログラムのディレクトリに移動
cd "C:\Users\xxxx"

# 4. プログラムを実行
python weighted_bayesian_fitting_completed.py
```

### 実行中の表示例

```
--- 0. 環境設定を開始します ---
🔧 PyTensor設定を初期化中...
💻 CPU設定を使用します。
✅ 設定ファイル 'config.yml' を読み込みました。
📁 結果保存ディレクトリ: C:\Users\taich\...\analysis_results\run_20251104_153045
```

---

## トラブルシューティング

### 🔴 問題1: `conda`コマンドが見つからない

**症状:**
```
conda : 用語 'conda' は、コマンドレット、関数、スクリプト ファイル、...
```

**原因:** PowerShellが再起動されていない、またはconda initが未実行

**解決策:**
```powershell
# 方法1: PowerShellを完全に閉じて、新しいウィンドウを開く

# 方法2: プロファイルを手動で読み込む
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
. "$env:USERPROFILE\OneDrive\画像\ドキュメント\WindowsPowerShell\profile.ps1"
```

---

### 🔴 問題2: 利用規約エラー（CondaToSNonInteractiveError）

**症状:**
```
CondaToSNonInteractiveError: Terms of Service have not been accepted for the following channels...
```

**原因:** デフォルトチャンネル（Anaconda公式）の利用規約が未承認

**解決策:**
すべてのcondaコマンドに `--override-channels -c conda-forge` を付ける
```powershell
# 良い例
conda install --override-channels -c conda-forge パッケージ名 -y

# 悪い例（エラーが出る）
conda install パッケージ名 -y
```

---

### 🔴 問題3: ImportError（パッケージが見つからない）

**症状:**
```python
ImportError: No module named 'pymc'
```

**原因:** 環境が有効化されていない、またはパッケージ未インストール

**解決策:**
```powershell
# 1. 環境を確認
conda env list
# 現在の環境に * マークが付いているか確認

# 2. 環境を有効化
conda activate ggg_bayesian

# 3. パッケージを確認
conda list | Select-String "pymc"

# 4. パッケージを再インストール
pip install pymc arviz pytensor
```

---

### 🔴 問題4: g++の警告が消えない

**症状:**
```
WARNING (pytensor.configdefaults): g++ not detected!
```

**原因:** gxxパッケージが未インストール、または環境変数が更新されていない

**解決策:**
```powershell
# 1. gxxを再インストール
conda install --override-channels -c conda-forge gxx -y

# 2. 環境を再起動
conda deactivate
conda activate ggg_bayesian

# 3. 確認
python -c "import pymc; print('OK')"
```

**注意:** 警告が出ても、プログラムは動作します（ただし遅い）

---

## よくある質問

### Q1: Python 3.13を使っても良いですか？

**A:** ❌ 推奨しません

**理由:**
- PyMC 5.x は Python 3.13に完全対応していない可能性がある
- ビルド済みパッケージ（wheel）が不足しており、インストールエラーが起きやすい
- 研究の再現性のため、安定版（Python 3.10または3.11）を使うべき

### Q2: Anacondaではなく、Minicondaでないとダメですか？

**A:** Anacondaでも可能ですが、Minicondaを推奨

**Minicondaの利点:**
- ディスク容量を節約（400MB vs 3〜5GB）
- 必要なパッケージだけインストールされるため、環境がクリーン
- インストールが速い

**Anacondaの利点:**
- 最初からJupyter Notebook等が使える
- GUIツール（Anaconda Navigator）が付属

### Q3: base環境でプログラムを実行してはいけませんか？

**A:** 可能ですが、推奨しません

**理由:**
- base環境を汚すと、他のプロジェクトに影響が出る
- パッケージの依存関係が複雑になり、トラブルが起きやすい
- 環境を削除して作り直すのが困難

**ベストプラクティス:** プロジェクトごとに専用環境を作る

### Q4: GPU（CUDA）は使えますか？

**A:** 使えます（オプション）

**手順:**
```powershell
# NumpyroとJAXをインストール（GPU版）
pip install numpyro
pip install --upgrade "jax[cuda12_pip]" -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

# CUDAドライバが必要（NVIDIA公式サイトからインストール）
```

**注意:** 
- CPU版でも十分高速
- GPU版は環境構築が複雑
- まずはCPU版で動作確認してから検討すること

### Q5: 環境を削除したい場合は？

```powershell
# 環境を削除
conda deactivate
conda env remove -n ggg_bayesian

# 確認
conda env list
```

### Q6: パッケージを更新したい場合は？

```powershell
# conda環境を有効化
conda activate ggg_bayesian

# condaパッケージを更新
conda update --override-channels -c conda-forge --all -y

# pipパッケージを更新
pip install --upgrade pymc arviz pytensor
```

---

## 参考リンク

### 公式ドキュメント
- Miniconda公式: https://docs.conda.io/en/latest/miniconda.html
- PyMC公式: https://www.pymc.io/
- ArviZ公式: https://arviz-devs.github.io/arviz/
- conda-forgeチャンネル: https://conda-forge.org/

### トラブルシューティング
- conda公式FAQ: https://docs.conda.io/projects/conda/en/latest/user-guide/troubleshooting.html
- PyMC Discourse（フォーラム）: https://discourse.pymc.io/

---

## 改訂履歴

*| 日付 | 版 | 変更内容 | 作成者 |
|------|-----|---------|--------|
| 2025/11/04 | 1.0 | 初版作成 | 中尾太一 |*

---

## サポート

このガイドに関する質問や問題がある場合は、研究室内で共有してください。
